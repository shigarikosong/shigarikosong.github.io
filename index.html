<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã«ã˜ã•ã‚“ã˜æ‰€å± å¸è³€ã‚Šã“ æ­Œã¾ã¨ã‚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .fade-in {
      animation: fadeIn 0.4s ease-out both;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body class="bg-white text-gray-800">
  <div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-center mb-8">å¸è³€ã‚Šã“ æ­Œã¾ã¨ã‚</h1>
    
    <!-- æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
    <div class="flex justify-between mb-4">
      <input id="searchInput" type="text" class="border p-2 w-full max-w-xs" placeholder="æ›²åã‚„ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã§æ¤œç´¢">
      <button id="sortButton" class="ml-4 px-4 py-2 border rounded bg-blue-500 text-white">å…¬é–‹æ—¥ã§ä¸¦ã³æ›¿ãˆ</button>
    </div>
    
    <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
    <div class="flex gap-4 mb-4">
      <div class="flex items-center gap-2">
        <label for="categoryFilter" class="text-sm">ã‚«ãƒ†ã‚´ãƒª:</label>
        <select id="categoryFilter" class="border p-2">
          <option value="">ã™ã¹ã¦</option>
          <option value="ã‚ã‚„ã‹ã">ã‚ã‚„ã‹ã</option>
          <option value="ã‚½ãƒ­">ã‚½ãƒ­</option>
          <option value="ã‚³ãƒ©ãƒœ">ã‚³ãƒ©ãƒœ</option>
        </select>
      </div>
      
      <div class="flex items-center gap-2">
        <label for="videoTypeFilter" class="text-sm">å‹•ç”»ç¨®åˆ¥:</label>
        <select id="videoTypeFilter" class="border p-2">
          <option value="">ã™ã¹ã¦</option>
          <option value="é€šå¸¸">é€šå¸¸</option>
          <option value="Shorts">Shorts</option>
          <option value="Tiktokå‹•ç”»">Tiktokå‹•ç”»</option>
        </select>
      </div>
    </div>
    
    <!-- å‹•ç”»ãƒªã‚¹ãƒˆ -->
    <div id="videoList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <template id="videoPlayerTemplate">
    <div class="video-player-container w-full mt-4 fade-in">
      <div class="bg-black rounded-xl overflow-hidden shadow-lg">
        <iframe class="w-full aspect-video" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
      </div>
    </div>
  </template>

  <div id="musicPlayer" class="fixed bottom-0 left-0 w-full bg-white border-t shadow z-50 px-4 py-2 flex flex-col gap-1 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex items-center gap-4">
      <button id="prevBtn" class="text-gray-700 hover:text-blue-600">â®ï¸</button>
      <button id="playBtn" class="text-gray-700 hover:text-blue-600">â–¶ï¸</button>
      <button id="nextBtn" class="text-gray-700 hover:text-blue-600">â­ï¸</button>
    </div>
    <div class="text-xs text-gray-600 text-center">
      <div id="nowPlaying" class="truncate">ğŸµ å†ç”Ÿä¸­: -</div>
      <div id="nextUp" class="truncate">ğŸ¶ æ¬¡: -</div>
    </div>
    <div class="flex items-center gap-3">
      <button id="shuffleToggleBtn" class="text-gray-400 hover:text-blue-500 transition">
        ğŸ”€
      </button>
      <button id="repeatToggleBtn" class="text-gray-400 hover:text-blue-500 transition">
        ğŸ”
      </button>
    </div>
  </div>

  <script>
    const sheetJsonUrl = 'https://opensheet.elk.sh/1sZGH3TGYdC5UShrIEFEe2T8-axXEFet6qsxbqCoHX5o/%E3%82%B7%E3%83%BC%E3%83%881';
    let allVideos = [];
    let currentIndex = -1;

    // å‹•ç”»ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function renderVideoList(videos) {
      const videoList = document.getElementById('videoList');
      videoList.innerHTML = '';

      // æ¤œç´¢ã¨ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½ã‚’é©ç”¨ã—ãŸå‹•ç”»è¡¨ç¤º
      const searchInput = document.getElementById('searchInput').value.toLowerCase();
      const categoryFilter = document.getElementById('categoryFilter').value;
      const videoTypeFilter = document.getElementById('videoTypeFilter').value;

      const filteredVideos = videos.filter(video => {
        const matchesSearch = video["title"].toLowerCase().includes(searchInput) || video["artist"].toLowerCase().includes(searchInput);
        const matchesCategory = categoryFilter ? video["ã‚«ãƒ†ã‚´ãƒª"] === categoryFilter : true;
        const matchesVideoType = videoTypeFilter ? video["å‹•ç”»ç¨®åˆ¥"] === videoTypeFilter : true;
        return matchesSearch && matchesCategory && matchesVideoType;
      });

      filteredVideos.forEach((video, index) => {
        const item = document.createElement('div');
        item.className = 'card p-4 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-xl transition-all';

        const title = document.createElement('a');
        title.href = '#';
        title.className = 'text-blue-600 font-semibold hover:underline';
        title.textContent = `${video["title"]} - ${video["artist"]}`;
        title.onclick = e => {
          e.preventDefault();
          loadVideoByIndex(index);
        };

        const meta = document.createElement('div');
        meta.className = 'text-sm text-gray-500 mt-2';
        meta.innerHTML = `ã‚«ãƒ†ã‚´ãƒª: ${video["ã‚«ãƒ†ã‚´ãƒª"]} / å…¬é–‹æ—¥: ${video["å…¬é–‹æ—¥"]} / ç¨®åˆ¥: ${video["å‹•ç”»ç¨®åˆ¥"]} / æ‹…å½“: ${video["æ‹…å½“åŒºåˆ†"]}`;

        const cardBody = document.createElement('div');
        cardBody.className = 'flex flex-col gap-2';
        cardBody.appendChild(title);
        cardBody.appendChild(meta);
        item.appendChild(cardBody);

        videoList.appendChild(item);
      });
    }

    // å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
    function loadVideo(video, container) {
      const start = parseInt(video["start"] || '0');
      let videoId = video["videoId"];
      const platform = video["platform"];
      let embedUrl = '';

      if (!videoId) return alert("videoId ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");

      if (platform.toLowerCase().includes("youtube")) {
        const match = videoId.match(/(?:v=|\/|youtu\.be\/)?([0-9A-Za-z_-]{11})/);
        if (match) videoId = match[1];
        embedUrl = `https://www.youtube.com/embed/${videoId}?start=${start}&autoplay=1&enablejsapi=1&origin=${location.origin}`;
      } else if (platform.toLowerCase() === 'tiktok') {
        const match = videoId.match(/video\/(\d+)/);
        const tiktokId = match ? match[1] : videoId;
        embedUrl = `https://www.tiktok.com/embed/v2/${tiktokId}`;
      }

      document.querySelectorAll('.video-player-container').forEach(el => el.remove());
      const template = document.getElementById('videoPlayerTemplate').content.cloneNode(true);
      template.querySelector('iframe').src = embedUrl;
      container.appendChild(template);
    }

    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç•ªå·ã§å‹•ç”»ã‚’è¡¨ç¤º
    function loadVideoByIndex(index) {
      const videos = document.querySelectorAll('#videoList > div');
      if (index < 0 || index >= videos.length) return;
      const title = videos[index].querySelector('a').textContent;
      let nextTitle = '-';

      const isShuffle = document.getElementById('shuffleToggle').checked;
      if (isShuffle) {
        let next;
        do {
          next = Math.floor(Math.random() * videos.length);
        } while (next === index);
        nextTitle = videos[next]?.querySelector('a')?.textContent || '-';
      } else {
        const nextIndex = (index + 1 < videos.length) ? index + 1 : (document.getElementById('repeatToggle').checked ? 0 : -1);
        if (nextIndex !== -1) {
          nextTitle = videos[nextIndex]?.querySelector('a')?.textContent || '-';
        }
      }

      updateNowNextDisplay(videos, title, nextTitle);

      const video = allVideos[index];
      const container = videos[index];
      loadVideo(video, container);

      currentIndex = index;
    }

    // æ¬¡ã®å‹•ç”»ã‚’å†ç”Ÿ
    function playNext() {
      const isShuffle = document.getElementById('shuffleToggle').checked;
      const videos = document.querySelectorAll('#videoList > div');
      if (isShuffle) {
        let next;
        do {
          next = Math.floor(Math.random() * videos.length);
        } while (next === currentIndex);
        loadVideoByIndex(next);
      } else {
        let nextIndex = currentIndex + 1;
        if (nextIndex >= videos.length) {
          if (document.getElementById('repeatToggle').checked) {
            nextIndex = 0;
          } else {
            updateNowNextDisplay(videos, videos[currentIndex]?.querySelector('a')?.textContent, null);
            return;
          }
        }
        loadVideoByIndex(nextIndex);
      }
    }

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰
    window.addEventListener('DOMContentLoaded', () => {
      fetch(sheetJsonUrl)
        .then(response => response.json())
        .then(data => {
          allVideos = data;  // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´
          renderVideoList(data);  // ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        });
    });

    // æ¤œç´¢ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('searchInput').addEventListener('input', () => {
      renderVideoList(allVideos);
    });

    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('categoryFilter').addEventListener('change', () => {
      renderVideoList(allVideos);
    });
    document.getElementById('videoTypeFilter').addEventListener('change', () => {
      renderVideoList(allVideos);
    });

    // ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('sortButton').addEventListener('click', () => {
      allVideos.sort((a, b) => new Date(b["å…¬é–‹æ—¥"]) - new Date(a["å…¬é–‹æ—¥"]));
      renderVideoList(allVideos);
    });
  </script>
</body>
</html>
