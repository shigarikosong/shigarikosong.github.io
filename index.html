<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã«ã˜ã•ã‚“ã˜æ‰€å± å¸è³€ã‚Šã“ æ­Œã¾ã¨ã‚</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-yellow-50 via-white to-blue-50 min-h-screen font-sans text-gray-800">
  <header class="sticky top-0 z-10 bg-white/70 backdrop-blur shadow-sm py-4">
    <h1 class="text-center text-3xl font-bold text-gray-900">ğŸ¤ ã«ã˜ã•ã‚“ã˜æ‰€å± å¸è³€ã‚Šã“ æ­Œã¾ã¨ã‚</h1>
  </header>

  <section class="max-w-6xl mx-auto mt-6 px-4">
    <div class="bg-white p-4 rounded-xl shadow-md grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
      <select id="categoryFilter" class="rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-blue-300">
        <option value="">ã‚«ãƒ†ã‚´ãƒª</option>
      </select>
      <select id="dateFilter" class="rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-blue-300">
        <option value="">å…¬é–‹æ—¥</option>
      </select>
      <select id="typeFilter" class="rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-blue-300">
        <option value="">å‹•ç”»ç¨®åˆ¥</option>
      </select>
      <select id="roleFilter" class="rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-blue-300">
        <option value="">æ‹…å½“åŒºåˆ†</option>
      </select>
      <input id="searchInput" type="text" placeholder="æ›²åãƒ»ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ" class="col-span-2 rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-blue-300" />
      <select id="sortOrder" class="rounded-lg border border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-2 focus:ring-blue-300">
        <option value="desc">æ–°ã—ã„é †</option>
        <option value="asc">å¤ã„é †</option>
      </select>
      <button id="resetFilters" class="bg-yellow-300 hover:bg-blue-300 text-black font-semibold text-sm px-4 py-2 rounded-lg shadow-sm transition">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
  </section>

  <main id="videoList" class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></main>

  <div id="videoPlayer" class="fixed bottom-0 left-0 w-full h-[30vh] bg-black flex justify-center items-center shadow-xl z-50">
    <!-- iframe will be inserted here -->
  </div>

  <script>
    const sheetJsonUrl = 'https://opensheet.elk.sh/1sZGH3TGYdC5UShrIEFEe2T8-axXEFet6qsxbqCoHX5o/%E3%82%B7%E3%83%BC%E3%83%881';
    let allVideos = [];

    window.addEventListener('DOMContentLoaded', () => {
      fetch(sheetJsonUrl)
        .then(response => response.json())
        .then(data => {
          allVideos = data;
          populateFilters(data);
          applyFilters();
        });

      const categoryFilter = document.getElementById('categoryFilter');
      const dateFilter = document.getElementById('dateFilter');
      const typeFilter = document.getElementById('typeFilter');
      const roleFilter = document.getElementById('roleFilter');
      const searchInput = document.getElementById('searchInput');
      const sortOrder = document.getElementById('sortOrder');
      const resetButton = document.getElementById('resetFilters');
      const videoList = document.getElementById('videoList');

      function populateFilters(videos) {
        const sets = {
          category: new Set(),
          date: new Set(),
          type: new Set(),
          role: new Set()
        };

        videos.forEach(v => {
          sets.category.add(v["ã‚«ãƒ†ã‚´ãƒª"]);
          sets.date.add(v["å…¬é–‹æ—¥"]);
          sets.type.add(v["å‹•ç”»ç¨®åˆ¥"]);
          sets.role.add(v["æ‹…å½“åŒºåˆ†"]);
        });

        addOptions(categoryFilter, [...sets.category].sort());
        addOptions(dateFilter, [...sets.date].sort());
        addOptions(typeFilter, [...sets.type].sort());
        addOptions(roleFilter, [...sets.role].sort());

        [categoryFilter, dateFilter, typeFilter, roleFilter, searchInput, sortOrder].forEach(el => {
          el.addEventListener('change', applyFilters);
          el.addEventListener('input', applyFilters);
        });

        resetButton.addEventListener('click', () => {
          categoryFilter.value = "";
          dateFilter.value = "";
          typeFilter.value = "";
          roleFilter.value = "";
          searchInput.value = "";
          sortOrder.value = "desc";
          applyFilters();
        });
      }

      function addOptions(select, values) {
        values.forEach(v => {
          if (!v) return;
          const option = document.createElement('option');
          option.value = v;
          option.textContent = v;
          select.appendChild(option);
        });
      }

      function applyFilters() {
        let filtered = allVideos.filter(video => {
          return (!categoryFilter.value || video["ã‚«ãƒ†ã‚´ãƒª"] === categoryFilter.value) &&
                 (!dateFilter.value || video["å…¬é–‹æ—¥"] === dateFilter.value) &&
                 (!typeFilter.value || video["å‹•ç”»ç¨®åˆ¥"] === typeFilter.value) &&
                 (!roleFilter.value || video["æ‹…å½“åŒºåˆ†"] === roleFilter.value) &&
                 (!searchInput.value ||
                  video["title"].toLowerCase().includes(searchInput.value.toLowerCase()) ||
                  video["artist"].toLowerCase().includes(searchInput.value.toLowerCase()));
        });

        filtered.sort((a, b) => {
          const dateA = new Date(a["å…¬é–‹æ—¥"]);
          const dateB = new Date(b["å…¬é–‹æ—¥"]);
          return sortOrder.value === "asc" ? dateA - dateB : dateB - dateA;
        });

        renderVideoList(filtered);
      }

      function renderVideoList(videos) {
        videoList.innerHTML = '';

        videos.forEach(video => {
          const card = document.createElement('div');
          card.className = 'bg-white rounded-xl shadow hover:shadow-lg p-4 transition border border-gray-100';

          const title = document.createElement('a');
          title.href = "#";
          title.className = 'block text-blue-600 font-medium text-lg hover:underline';
          title.textContent = `${video["title"]} - ${video["artist"]}`;
          title.onclick = e => {
            e.preventDefault();
            loadVideo(video);
          };

          const meta = document.createElement('div');
          meta.className = 'text-sm text-gray-500 mt-2 space-y-1';
          meta.innerHTML = `
            <div><span class="font-semibold">ã‚«ãƒ†ã‚´ãƒª:</span> ${video["ã‚«ãƒ†ã‚´ãƒª"]}</div>
            <div><span class="font-semibold">å…¬é–‹æ—¥:</span> ${video["å…¬é–‹æ—¥"]}</div>
            <div><span class="font-semibold">å‹•ç”»ç¨®åˆ¥:</span> ${video["å‹•ç”»ç¨®åˆ¥"]}</div>
            <div><span class="font-semibold">æ‹…å½“åŒºåˆ†:</span> ${video["æ‹…å½“åŒºåˆ†"]}</div>
          `;

          card.appendChild(title);
          card.appendChild(meta);
          videoList.appendChild(card);
        });
      }

      function loadVideo(video) {
        const start = parseInt(video["start"] || '0');
        let videoId = video["videoId"];
        const platform = video["platform"];
        let embedUrl = "";

        if (!videoId) return alert("videoId ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");

        if (platform.toLowerCase().includes("youtube")) {
          const match = videoId.match(/(?:v=|\/|youtu\.be\/)?([0-9A-Za-z_-]{11})/);
          if (match) videoId = match[1];
          embedUrl = `https://www.youtube.com/embed/${videoId}?start=${start}&autoplay=1`;
        } else if (platform.toLowerCase() === "tiktok") {
          const match = videoId.match(/video\/(\d+)/);
          const tiktokId = match ? match[1] : videoId;
          embedUrl = `https://www.tiktok.com/embed/v2/${tiktokId}`;
        }

        document.getElementById('videoPlayer').innerHTML = `<iframe src="${embedUrl}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen class="w-[90%] h-full max-w-3xl"></iframe>`;
      }
    });
  </script>
</body>
</html>
